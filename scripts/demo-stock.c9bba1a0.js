"use strict";var gainOrLossChart=dc.pieChart("#gain-loss-chart"),fluctuationChart=dc.barChart("#fluctuation-chart"),quarterChart=dc.pieChart("#quarter-chart"),dayOfWeekChart=dc.rowChart("#day-of-week-chart"),moveChart=dc.lineChart("#monthly-move-chart"),volumeChart=dc.barChart("#monthly-volume-chart"),yearlyBubbleChart=dc.bubbleChart("#yearly-bubble-chart");d3.csv("data/demo-stock.csv",function(a){var b=d3.time.format("%m/%d/%Y"),c=d3.format(".2f");a.forEach(function(a){a.dd=b.parse(a.date),a.month=d3.time.month(a.dd),a.close=+a.close,a.open=+a.open});var d=crossfilter(a),e=d.groupAll(),f=d.dimension(function(a){return d3.time.year(a.dd).getFullYear()}),g=f.group().reduce(function(a,b){return++a.count,a.absGain+=b.close-b.open,a.fluctuation+=Math.abs(b.close-b.open),a.sumIndex+=(b.open+b.close)/2,a.avgIndex=a.sumIndex/a.count,a.percentageGain=a.avgIndex?a.absGain/a.avgIndex*100:0,a.fluctuationPercentage=a.avgIndex?a.fluctuation/a.avgIndex*100:0,a},function(a,b){return--a.count,a.absGain-=b.close-b.open,a.fluctuation-=Math.abs(b.close-b.open),a.sumIndex-=(b.open+b.close)/2,a.avgIndex=a.count?a.sumIndex/a.count:0,a.percentageGain=a.avgIndex?a.absGain/a.avgIndex*100:0,a.fluctuationPercentage=a.avgIndex?a.fluctuation/a.avgIndex*100:0,a},function(){return{count:0,absGain:0,fluctuation:0,fluctuationPercentage:0,sumIndex:0,avgIndex:0,percentageGain:0}}),h=d.dimension(function(a){return a.dd}),i=d.dimension(function(a){return a.month}),j=i.group().reduceSum(function(a){return Math.abs(a.close-a.open)}),k=i.group().reduceSum(function(a){return a.volume/5e5}),l=i.group().reduce(function(a,b){return++a.days,a.total+=(b.open+b.close)/2,a.avg=Math.round(a.total/a.days),a},function(a,b){return--a.days,a.total-=(b.open+b.close)/2,a.avg=a.days?Math.round(a.total/a.days):0,a},function(){return{days:0,total:0,avg:0}}),m=d.dimension(function(a){return a.open>a.close?"Loss":"Gain"}),n=m.group(),o=d.dimension(function(a){return Math.round((a.close-a.open)/a.open*100)}),p=o.group(),q=d.dimension(function(a){var b=a.dd.getMonth();return 2>=b?"Q1":b>2&&5>=b?"Q2":b>5&&8>=b?"Q3":"Q4"}),r=q.group().reduceSum(function(a){return a.volume}),s=d.dimension(function(a){var b=a.dd.getDay(),c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return b+"."+c[b]}),t=s.group();yearlyBubbleChart.width($(yearlyBubbleChart.root()[0]).parent().width()).height(250).transitionDuration(1500).margins({top:10,right:50,bottom:30,left:40}).dimension(f).group(g).colors(colorbrewer.RdYlGn[9]).colorDomain([-500,500]).colorAccessor(function(a){return a.value.absGain}).keyAccessor(function(a){return a.value.absGain}).valueAccessor(function(a){return a.value.percentageGain}).radiusValueAccessor(function(a){return a.value.fluctuationPercentage}).maxBubbleRelativeSize(.3).x(d3.scale.linear().domain([-2500,2500])).y(d3.scale.linear().domain([-100,100])).r(d3.scale.linear().domain([0,4e3])).elasticY(!0).elasticX(!0).yAxisPadding(100).xAxisPadding(500).renderHorizontalGridLines(!0).renderVerticalGridLines(!0).xAxisLabel("Index Gain").yAxisLabel("Index Gain %").renderLabel(!0).label(function(a){return a.key}).renderTitle(!0).title(function(a){return[a.key,"Index Gain: "+c(a.value.absGain),"Index Gain in Percentage: "+c(a.value.percentageGain)+"%","Fluctuation / Index Ratio: "+c(a.value.fluctuationPercentage)+"%"].join("\n")}).yAxis().tickFormat(function(a){return a+"%"}),gainOrLossChart.width(180).height(180).radius(80).dimension(m).group(n).label(function(a){if(gainOrLossChart.hasFilter()&&!gainOrLossChart.hasFilter(a.key))return a.key+"(0%)";var b=a.key;return e.value()&&(b+="("+Math.floor(a.value/e.value()*100)+"%)"),b}),quarterChart.width(180).height(180).radius(80).innerRadius(30).dimension(q).group(r),dayOfWeekChart.width(180).height(180).margins({top:20,left:10,right:10,bottom:20}).group(t).dimension(s).label(function(a){return a.key.split(".")[1]}).title(function(a){return a.value}).elasticX(!0).xAxis().ticks(4),fluctuationChart.dimension(o).group(p).margins({top:10,right:10,bottom:30,left:30}).width($(fluctuationChart.root()[0]).parent().width()).height(180).elasticY(!0).centerBar(!0).gap(1).round(dc.round.floor).alwaysUseRounding(!0).x(d3.scale.linear().domain([-25,25])).renderHorizontalGridLines(!0).filterPrinter(function(a){var b=a[0],d="";return d+=c(b[0])+"% -> "+c(b[1])+"%"}),fluctuationChart.xAxis().tickFormat(function(a){return a+"%"}),fluctuationChart.yAxis().ticks(5),moveChart.renderArea(!0).width($(moveChart.root()[0]).parent().width()).height(200).transitionDuration(1e3).margins({top:30,right:50,bottom:25,left:40}).dimension(i).mouseZoomable(!0).rangeChart(volumeChart).x(d3.time.scale().domain([new Date(1985,0,1),new Date(2012,11,31)])).round(d3.time.month.round).xUnits(d3.time.months).elasticY(!0).renderHorizontalGridLines(!0).legend(dc.legend().x(800).y(10).itemHeight(13).gap(5)).brushOn(!1).group(l,"Monthly Index Average").valueAccessor(function(a){return a.value.avg}).stack(j,"Monthly Index Move",function(a){return a.value}).title(function(a){var d=a.value.avg?a.value.avg:a.value;return isNaN(d)&&(d=0),b(a.key)+"\n"+c(d)}),volumeChart.width($(volumeChart.root()[0]).parent().width()).height(40).margins({top:0,right:50,bottom:20,left:40}).dimension(i).group(k).centerBar(!0).gap(1).x(d3.time.scale().domain([new Date(1985,0,1),new Date(2012,11,31)])).round(d3.time.month.round).alwaysUseRounding(!0).xUnits(d3.time.months),dc.dataCount(".dc-data-count").dimension(d).group(e).html({some:"<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records | <a href='javascript:dc.filterAll(); dc.renderAll();''>Reset All</a>",all:"All records selected. Please click on the graph to apply filters."}),dc.dataTable(".dc-data-table").dimension(h).group(function(a){var b=d3.format("02d");return a.dd.getFullYear()+"/"+b(a.dd.getMonth()+1)}).size(10).columns(["date","open","close",{label:"Change",format:function(a){return c(a.close-a.open)}},"volume"]).sortBy(function(a){return a.dd}).order(d3.ascending).renderlet(function(a){a.selectAll(".dc-table-group").classed("info",!0)}),dc.renderAll()}),d3.selectAll("#version").text(dc.version),d3.json("https://api.github.com/repos/dc-js/dc.js/releases/latest",function(a,b){d3.selectAll("#latest").text(b.tag_name)});